<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>
  Queries when you have a postgresql based system

    </title>
    
    <link rel="stylesheet" href="/css/main.min.b0ac2a435097757bc0f52ca79b98b87531ff99fa1b4c88d169395513962577d9.css" /><meta property="og:title" content="Queries when you have a postgresql based system" />
<meta property="og:description" content="Are you managing/developing a PostgreSQL based application? Here are some scripts that might make your life easier dealing with your installation:
selectschema_name,relname,pg_size_pretty(table_size)from(selectpg_catalog.pg_namespace.nspnameasschema_name,relname,pg_total_relation_size(pg_catalog.pg_class.oid)astable_sizefrompg_catalog.pg_classjoinpg_catalog.pg_namespaceonrelnamespace=pg_catalog.pg_namespace.oid)twhereschema_namenotlike&#39;pg_%&#39;orderbytable_sizedesclimit5;Code Snippet 1: Check the 5 largests tables (courtesy of Supabase&#39;s dashboard)  select*fromcron.job_run_detailsorderbystart_timedesclimit5;Code Snippet 2: Check the current running cron jobs  selectact.query,act.datname,act.query_start,nspnameasschema_name,relnameasobject_name,l.pidfrompg_locksljoinpg_classcon(relation=c.oid)joinpg_namespacenspon(c.relnamespace=nsp.oid)joinpg_stat_activityacton(l.pid=act.pid)wherel.pidin(selectpidfrompg_stat_activitywheredatname=current_database()andquery!=current_query())orderbypid;Code Snippet 3: See what is being locked by what (pg_terminate can unlock things) " />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://ebellani.github.io/blog/2025/queries-when-you-have-a-postgresql-based-system/" /><meta property="article:section" content="blog" />
<meta property="article:published_time" content="2025-03-24T00:00:00+00:00" />
<meta property="article:modified_time" content="2025-03-24T00:00:00+00:00" />

</head>
  <body><nav>
  <img
    src="/img/triquetra.png"
    alt="put your logo here"
    width="128"
    height="128"
  />
  <h1>Eduardo&#39;s blog</h1>
  <ul>
    <li><a href="/">Home</a></li>
    <li><a href="/blog">Blog</a></li>
  </ul>
</nav>
<main>
  <h2>Queries when you have a postgresql based system
    <small>
      <time>March 24, 2025</time>
    by Eduardo Bellani


    </small>
  </h2><p>Are you managing/developing a PostgreSQL based application? Here are some scripts
that might make your life easier dealing with your installation:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-sql" data-lang="sql"><span class="line"><span class="cl"><span class="w">  </span><span class="k">select</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="k">schema_name</span><span class="p">,</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">relname</span><span class="p">,</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">pg_size_pretty</span><span class="p">(</span><span class="n">table_size</span><span class="p">)</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="k">from</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="p">(</span><span class="k">select</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">         </span><span class="n">pg_catalog</span><span class="p">.</span><span class="n">pg_namespace</span><span class="p">.</span><span class="n">nspname</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="k">schema_name</span><span class="p">,</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">         </span><span class="n">relname</span><span class="p">,</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">         </span><span class="n">pg_total_relation_size</span><span class="p">(</span><span class="n">pg_catalog</span><span class="p">.</span><span class="n">pg_class</span><span class="p">.</span><span class="n">oid</span><span class="p">)</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="n">table_size</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">         </span><span class="k">from</span><span class="w"> </span><span class="n">pg_catalog</span><span class="p">.</span><span class="n">pg_class</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">              </span><span class="k">join</span><span class="w"> </span><span class="n">pg_catalog</span><span class="p">.</span><span class="n">pg_namespace</span><span class="w"> </span><span class="k">on</span><span class="w"> </span><span class="n">relnamespace</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">pg_catalog</span><span class="p">.</span><span class="n">pg_namespace</span><span class="p">.</span><span class="n">oid</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="p">)</span><span class="w"> </span><span class="n">t</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">   </span><span class="k">where</span><span class="w"> </span><span class="k">schema_name</span><span class="w"> </span><span class="k">not</span><span class="w"> </span><span class="k">like</span><span class="w"> </span><span class="s1">&#39;pg_%&#39;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">   </span><span class="k">order</span><span class="w"> </span><span class="k">by</span><span class="w"> </span><span class="n">table_size</span><span class="w"> </span><span class="k">desc</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">   </span><span class="k">limit</span><span class="w"> </span><span class="mi">5</span><span class="p">;</span><span class="w">
</span></span></span></code></pre></div><div class="src-block-caption">
  <span class="src-block-number">Code Snippet 1:</span>
  Check the 5 largests tables (courtesy of Supabase's dashboard)
</div>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-sql" data-lang="sql"><span class="line"><span class="cl"><span class="w">  </span><span class="k">select</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="k">from</span><span class="w"> </span><span class="n">cron</span><span class="p">.</span><span class="n">job_run_details</span><span class="w"> </span><span class="k">order</span><span class="w"> </span><span class="k">by</span><span class="w"> </span><span class="n">start_time</span><span class="w"> </span><span class="k">desc</span><span class="w"> </span><span class="k">limit</span><span class="w"> </span><span class="mi">5</span><span class="p">;</span><span class="w">
</span></span></span></code></pre></div><div class="src-block-caption">
  <span class="src-block-number">Code Snippet 2:</span>
  Check the current running cron jobs
</div>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-sql" data-lang="sql"><span class="line"><span class="cl"><span class="w">  </span><span class="k">select</span><span class="w"> </span><span class="n">act</span><span class="p">.</span><span class="n">query</span><span class="p">,</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">         </span><span class="n">act</span><span class="p">.</span><span class="n">datname</span><span class="p">,</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">         </span><span class="n">act</span><span class="p">.</span><span class="n">query_start</span><span class="p">,</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">         </span><span class="n">nspname</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="k">schema_name</span><span class="p">,</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">         </span><span class="n">relname</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="n">object_name</span><span class="p">,</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">         </span><span class="n">l</span><span class="p">.</span><span class="n">pid</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="k">from</span><span class="w"> </span><span class="n">pg_locks</span><span class="w"> </span><span class="n">l</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">         </span><span class="k">join</span><span class="w"> </span><span class="n">pg_class</span><span class="w"> </span><span class="k">c</span><span class="w"> </span><span class="k">on</span><span class="w"> </span><span class="p">(</span><span class="n">relation</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">c</span><span class="p">.</span><span class="n">oid</span><span class="p">)</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">         </span><span class="k">join</span><span class="w"> </span><span class="n">pg_namespace</span><span class="w"> </span><span class="n">nsp</span><span class="w"> </span><span class="k">on</span><span class="w"> </span><span class="p">(</span><span class="k">c</span><span class="p">.</span><span class="n">relnamespace</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">nsp</span><span class="p">.</span><span class="n">oid</span><span class="p">)</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">         </span><span class="k">join</span><span class="w"> </span><span class="n">pg_stat_activity</span><span class="w"> </span><span class="n">act</span><span class="w"> </span><span class="k">on</span><span class="w"> </span><span class="p">(</span><span class="n">l</span><span class="p">.</span><span class="n">pid</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">act</span><span class="p">.</span><span class="n">pid</span><span class="p">)</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">   </span><span class="k">where</span><span class="w"> </span><span class="n">l</span><span class="p">.</span><span class="n">pid</span><span class="w"> </span><span class="k">in</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">         </span><span class="p">(</span><span class="k">select</span><span class="w"> </span><span class="n">pid</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="k">from</span><span class="w"> </span><span class="n">pg_stat_activity</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">           </span><span class="k">where</span><span class="w"> </span><span class="n">datname</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">current_database</span><span class="p">()</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">             </span><span class="k">and</span><span class="w"> </span><span class="n">query</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="n">current_query</span><span class="p">())</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">   </span><span class="k">order</span><span class="w"> </span><span class="k">by</span><span class="w"> </span><span class="n">pid</span><span class="p">;</span><span class="w">
</span></span></span></code></pre></div><div class="src-block-caption">
  <span class="src-block-number">Code Snippet 3:</span>
  See what is being locked by what (pg_terminate can unlock things)
</div>


   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   





<footer>
  <p>Feel free to send me an email: ebellani -at- gmail -dot- com</p>
  <p>
    Fingerprint: 48C50C6F1139C5160AA0DC2BC54D00BC4DF7CA7C
  </p>
</footer>

      </main>
    </main>
  </body>
</html>
