<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>
  How I do development on PostgreSQL over Emacs

    </title>
    
    <link rel="stylesheet" href="/css/main.min.b0ac2a435097757bc0f52ca79b98b87531ff99fa1b4c88d169395513962577d9.css" /><meta property="og:title" content="How I do development on PostgreSQL over Emacs" />
<meta property="og:description" content="These days I&rsquo;m doing quite a lot of work in PostgreSql. Given that my tool of choice is Emacs, I had to learn how to make do. This post&rsquo;s goal is to document that.
First, I set up a connection
(add-to-list &#39;sql-connection-alist `(production-read-only (sql-product &#39;postgres) (sql-user &#34;prod_user&#34;) (sql-server &#34;data-aurora.cluster-ro.us-east-1.rds.amazonaws.com&#34;) (sql-database &#34;ProdDB&#34;))) Since this uses psql under the covers and I want to not to have to type passwords all the time, I store the passwords in ~/." />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://ebellani.github.io/blog/2024/how-to-do-development-on-postgresql-over-emacs/" /><meta property="article:section" content="blog" />
<meta property="article:published_time" content="2024-02-24T00:00:00+00:00" />
<meta property="article:modified_time" content="2024-02-24T00:00:00+00:00" />

</head>
  <body><nav>
  <img
    src="/img/triquetra.png"
    alt="put your logo here"
    width="128"
    height="128"
  />
  <h1>Eduardo&#39;s blog</h1>
  <ul>
    <li><a href="/">Home</a></li>
    <li><a href="/blog">Blog</a></li>
  </ul>
</nav>
<main>
  <h2>How I do development on PostgreSQL over Emacs
    <small>
      <time>February 24, 2024</time>
    by Eduardo Bellani


    </small>
  </h2><p>These days I&rsquo;m doing quite a lot of work in PostgreSql. Given that my
tool of choice is Emacs, I had to learn how to make do. This post&rsquo;s goal
is to document that.</p>
<p>First, I set up a connection</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-elisp" data-lang="elisp"><span class="line"><span class="cl">  <span class="p">(</span><span class="nv">add-to-list</span> <span class="ss">&#39;sql-connection-alist</span>
</span></span><span class="line"><span class="cl">               <span class="o">`</span><span class="p">(</span><span class="nv">production-read-only</span> <span class="p">(</span><span class="nv">sql-product</span> <span class="ss">&#39;postgres</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">                                      <span class="p">(</span><span class="nv">sql-user</span>    <span class="s">&#34;prod_user&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">                                      <span class="p">(</span><span class="nv">sql-server</span> <span class="s">&#34;data-aurora.cluster-ro.us-east-1.rds.amazonaws.com&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">                                      <span class="p">(</span><span class="nv">sql-database</span>   <span class="s">&#34;ProdDB&#34;</span><span class="p">)))</span>
</span></span></code></pre></div><p>Since this uses psql under the covers and I want to not to have to type
passwords all the time, I store the passwords in <code>~/.pgpass</code>.</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-shell" data-lang="shell"><span class="line"><span class="cl">  <span class="c1"># hostname:port:database:username:password</span>
</span></span><span class="line"><span class="cl">  data-aurora.cluster-ro.us-east-1.rds.amazonaws.com:5432:ProdDB:prod_user:the_password
</span></span></code></pre></div><p>In order to make life a bit better over at psql&rsquo;s prompt, I have a
<code>.psqlrc</code> file with the following:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-shell" data-lang="shell"><span class="line"><span class="cl">  <span class="se">\s</span>et QUIET <span class="m">1</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="se">\s</span>et PROMPT1 <span class="s1">&#39;(%n@%m) [%/] &gt; &#39;</span>
</span></span><span class="line"><span class="cl">  <span class="se">\s</span>et PROMPT2 <span class="s1">&#39;&#39;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="se">\p</span>set null <span class="s1">&#39;[null]&#39;</span>
</span></span><span class="line"><span class="cl">  <span class="se">\s</span>et COMP_KEYWORD_CASE upper
</span></span><span class="line"><span class="cl">  <span class="se">\s</span>et HISTSIZE <span class="m">2000</span>
</span></span><span class="line"><span class="cl">  <span class="se">\s</span>et VERBOSITY verbose
</span></span><span class="line"><span class="cl">  <span class="se">\p</span>set linestyle unicode
</span></span><span class="line"><span class="cl">  <span class="se">\p</span>set border <span class="m">2</span>
</span></span><span class="line"><span class="cl">  <span class="se">\p</span>set format wrapped
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="se">\s</span>et QUIET <span class="m">0</span>
</span></span></code></pre></div><p>Finally, I&rsquo;d like to keep the history of commands. Here is how I enable that on comint-mode:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-elisp" data-lang="elisp"><span class="line"><span class="cl">  <span class="p">(</span><span class="nb">use-package</span> <span class="nv">comint</span>
</span></span><span class="line"><span class="cl">    <span class="c1">;; This is based on</span>
</span></span><span class="line"><span class="cl">    <span class="c1">;; https://oleksandrmanzyuk.wordpress.com/2011/10/23/a-persistent-command-history-in-emacs/</span>
</span></span><span class="line"><span class="cl">    <span class="c1">;; The idea is to store sessions of comint based modes. For example, to enable</span>
</span></span><span class="line"><span class="cl">    <span class="c1">;; reading/writing of command history in, say, inferior-haskell-mode buffers,</span>
</span></span><span class="line"><span class="cl">    <span class="c1">;; simply add turn-on-comint-history to inferior-haskell-mode-hook by adding</span>
</span></span><span class="line"><span class="cl">    <span class="c1">;; it to the :hook directive</span>
</span></span><span class="line"><span class="cl">    <span class="nb">:config</span>
</span></span><span class="line"><span class="cl">    <span class="p">(</span><span class="nb">defun</span> <span class="nv">comint-write-history-on-exit</span> <span class="p">(</span><span class="nv">process</span> <span class="nv">event</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">      <span class="p">(</span><span class="nv">comint-write-input-ring</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">      <span class="p">(</span><span class="nb">let</span> <span class="p">((</span><span class="nv">buf</span> <span class="p">(</span><span class="nf">process-buffer</span> <span class="nv">process</span><span class="p">)))</span>
</span></span><span class="line"><span class="cl">        <span class="p">(</span><span class="nb">when</span> <span class="p">(</span><span class="nf">buffer-live-p</span> <span class="nv">buf</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">          <span class="p">(</span><span class="nb">with-current-buffer</span> <span class="nv">buf</span>
</span></span><span class="line"><span class="cl">            <span class="p">(</span><span class="nf">insert</span> <span class="p">(</span><span class="nf">format</span> <span class="s">&#34;\nProcess %s %s&#34;</span> <span class="nv">process</span> <span class="nv">event</span><span class="p">))))))</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="p">(</span><span class="nb">defun</span> <span class="nv">turn-on-comint-history</span> <span class="p">()</span>
</span></span><span class="line"><span class="cl">      <span class="p">(</span><span class="nb">let</span> <span class="p">((</span><span class="nv">process</span> <span class="p">(</span><span class="nf">get-buffer-process</span> <span class="p">(</span><span class="nf">current-buffer</span><span class="p">))))</span>
</span></span><span class="line"><span class="cl">        <span class="p">(</span><span class="nb">when</span> <span class="nv">process</span>
</span></span><span class="line"><span class="cl">          <span class="p">(</span><span class="nb">setq</span> <span class="nv">comint-input-ring-file-name</span>
</span></span><span class="line"><span class="cl">                <span class="p">(</span><span class="nf">format</span> <span class="s">&#34;~/.emacs.d/inferior-%s-history&#34;</span>
</span></span><span class="line"><span class="cl">                        <span class="p">(</span><span class="nf">process-name</span> <span class="nv">process</span><span class="p">)))</span>
</span></span><span class="line"><span class="cl">          <span class="p">(</span><span class="nv">comint-read-input-ring</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">          <span class="p">(</span><span class="nf">set-process-sentinel</span> <span class="nv">process</span>
</span></span><span class="line"><span class="cl">                                <span class="nf">#&#39;</span><span class="nv">comint-write-history-on-exit</span><span class="p">))))</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="p">(</span><span class="nb">defun</span> <span class="nv">mapc-buffers</span> <span class="p">(</span><span class="nv">fn</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">      <span class="p">(</span><span class="nf">mapc</span> <span class="p">(</span><span class="nb">lambda</span> <span class="p">(</span><span class="nv">buffer</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">              <span class="p">(</span><span class="nb">with-current-buffer</span> <span class="nv">buffer</span>
</span></span><span class="line"><span class="cl">                <span class="p">(</span><span class="nf">funcall</span> <span class="nv">fn</span><span class="p">)))</span>
</span></span><span class="line"><span class="cl">            <span class="p">(</span><span class="nf">buffer-list</span><span class="p">)))</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="p">(</span><span class="nb">defun</span> <span class="nv">comint-write-input-ring-all-buffers</span> <span class="p">()</span>
</span></span><span class="line"><span class="cl">      <span class="p">(</span><span class="nv">mapc-buffers</span> <span class="ss">&#39;comint-write-input-ring</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="p">(</span><span class="nv">add-hook</span> <span class="ss">&#39;kill-emacs-hook</span> <span class="ss">&#39;comint-write-input-ring-all-buffers</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="p">(</span><span class="nv">add-hook</span> <span class="ss">&#39;kill-buffer-hook</span> <span class="ss">&#39;comint-write-input-ring</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="p">(</span><span class="nb">use-package</span> <span class="nv">sql</span>
</span></span><span class="line"><span class="cl">    <span class="nb">:after</span> <span class="nv">comint</span>
</span></span><span class="line"><span class="cl">    <span class="nb">:config</span>
</span></span><span class="line"><span class="cl">    <span class="p">(</span><span class="nv">add-hook</span> <span class="ss">&#39;sql-interactive-mode-hook</span> <span class="ss">&#39;turn-on-comint-history</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="p">(</span><span class="nb">setq</span> <span class="nv">sql-password-wallet</span> <span class="p">(</span><span class="nf">list</span> <span class="s">&#34;~/.authinfo.gpg&#34;</span><span class="p">)))</span>
</span></span></code></pre></div>


   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   





<footer>
  <p>Feel free to send me an email: ebellani -at- gmail -dot- com</p>
  <p>
    Fingerprint: 48C50C6F1139C5160AA0DC2BC54D00BC4DF7CA7C
  </p>
</footer>

      </main>
    </main>
  </body>
</html>
